# GNU awk

在Linux有文本三剑客，分别是grep、sed和awk，grep是文本过滤工具，sed是流编辑器，awk是一个报告生成器，用来格式化文本输出。awk的全称是Aho, Weinberger, Kernighan，这是awk的三个作者。awk有三个版本，一个是用于unix的awk，用于linux的gawk，还有一个new awk。

awk的基本用法gawk [options] 'program' FILE ...，program有两部分组成，PATTERN{ACTION STATEMENTS}，多个语句用分号分隔。

选项

```
-F：指明输入时用到的字段分隔符；
-v var=value: 自定义变量，对awk变量名区分字符大小写，定义变量也可以在program中直接定义
```

awk的工作模式



**print：print item1，item2**

(1) 逗号分隔符；

(2)输出的各item可以是字符串，也可以数值、当前记录的字段、变量、或awk的表达式

(3)变量要进行替换，不要放到引号里

(4)如省略item，相当于print $，显示整行字符。

**变量**

awk有内建变量和自定义变量

内建变量

```
FS：input field seperator，默认为空白字符；指定其他分隔符-v FS=':'
OFS：output field seperator，默认为空白字符；指定输出的分隔符-v OFS=':'
RS：input record seperator，输入时的换行符；
ORS：output record seperator，输出时的换行符；

NF：number of field，字段数量，如awk '{print NF}' /etc/fstab
NR：number of record, 行数；
FNR：各文件分别计数；行数；

FILENAME：当前文件名；

ARGC：命令行参数的个数；
ARGV：数组，保存的是命令行所给定的各参数；
```

自定义变量的使用：awk -v test=‘hellp gawk’ ‘BEGIN{print test}’或awk 'BEGIN{test="hello gawk";print test}'

**printf命令**

格式化输出：printf FORMAT, item1, item2, ...，如awk -F：‘{printf  “Username：%s,UID：\n%d\n”,$1,\$3}’ /etc/passwd

(1) FORMAT必须给出; 

(2) 不会自动换行，需要显式给出换行控制符，\n

(3) FORMAT中需要分别为后面的每个item指定一个格式化符号；

格式符和修饰符

```
%c: 显示字符的ASCII码；
%d, %i: 显示十进制整数；
%e, %E: 科学计数法数值显示；
%f：显示为浮点数；
%g, %G：以科学计数法或浮点形式显示数值；
%s：显示字符串；
%u：无符号整数；
%%: 显示%自身；
修饰符
#[.#]：第一个数字控制显示的宽度；第二个#表示小数点后的精度；%3.1f，如awk -F：‘{printf  “Username：%-15s,UID：\n%d\n”,$1,$3}’ /etc/passwd
-: 左对齐
+：显示数值的符号
```

**操作符**

算术操作符：x+y, x-y, x*y, x/y, x^y, x%y，-x，+x: 转换为数值；

字符串操作符：没有符号的操作符表示字符串连接

赋值操作符：=, +=, -=, *=, /=, %=, ^=，++, --

比较操作符：>, >=, <, <=, !=, ==

模式匹配符：~是否匹配；!~是否不匹配

逻辑操作符：&&，||，!

函数调用：function_name(argu1, argu2, ...)

条件表达式：selector?if-true-expression:if-false-expression，如 awk -F: '{\$3>=1000?usertype="Common User":usertype="Sysadmin or SysUser";printf "%15s:%-s\n",$1,usertype}' /etc/passwd

**PATTERN**类似于sed的地址定界

(1) empty：空模式，匹配每一行；

(2) /regular expression/：仅处理能够被此处的模式匹配到的行；

(3) relational expression: 关系表达式；结果有“真”有“假”；结果为“真”才会被处理；真：结果为非0值，非空字符串；如awk -F ： ’$3>=1000{print $1,$3}‘ /etc/passwd

(4) line ranges：行范围，startline,endline：/pat1/,/pat2/。注意： 不支持直接给出数字的格式。如awk -F: '(NR>=2&&NR<=10){print $1}' /etc/passwd

(5) BEGIN/END模式:BEGIN{}: 仅在开始处理文件中的文本之前执行一次；END{}：仅在文本处理完成之后执行一次；

**常用的action**

(1) Expressions

(2) Control statements：if, while等；

(3) Compound statements：组合语句；

(4) input statements

(5) output statements

**控制语句**

if(condition) {statments} 
if(condition) {statments} else {statements}
while(conditon) {statments}
do {statements} while(condition)
for(expr1;expr2;expr3) {statements}
break
continue
delete array[index]
delete array
exit 
{ statements }

if-else的使用例子

语法：if(condition) statement [else statement]

awk -F: '{if($3>=1000) {printf "Common user: %s\n",$1} else {printf "root or Sysuser: %s\n",$1}}' /etc/passwd

awk -F: '{if(\$NF=="/bin/bash") print $1}' /etc/passwd

awk '{if(NF>5) print $0}' /etc/fstab

df -h | awk -F[%] '/^\/dev/{print \$1}' | awk '{if(\$NF>=80) print $1}'

使用场景：对awk取得的整行或某个字段做条件判断；

while循环使用的例子

语法：while(condition) statement
条件“真”，进入循环；条件“假”，退出循环；

使用场景：对一行内的多个字段逐一类似处理时使用；对数组中的各元素逐一处理时使用；

~]# awk '/^[[:space:]]*linux16/{i=1;while(i<=NF) {print \$i,length($i); i++}}' /etc/grub2.cfg

~]# awk '/^[[:space:]]*linux16/{i=1;while(i<=NF) {if(length($i)>=7) {print $i,length($i)}; i++}}' /etc/grub2.cfg

