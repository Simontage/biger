# sudo和文件共享服务

切换用户使用su或su -，su只是切换到root身份，shell环境仍然是普通用户的shell，su -是用户和shell环境都切换到了root。使用-c COMMAND可以变更为使用者的身份并且执行指令后变回原来的使用者。使用-l选项表示改变身份时，也同时变更工作目录，以及HOME、SHELL、USER、logname，此外也会变更PATH环境变量。

sudo可以让某用户不需要管理员的密码，就可以拥有管理员的权限。sudo是一种授权机制，授权之后能够让某用户以另外一个用户的身份运行命令。sudo的配置文件是/etc/sudoers。也可以使用visudo来编辑配置文件。授权在配置文件中以类似`root    ALL=(ALL)       ALL`的格式进行授权，也可以对用户组进行授权。其中第一个字段user是运行命令者的身份，第二字段host是通过哪些主机，等号右侧ranas表示以哪个用户的身份运行，第三个字段command表示可以运行哪些命令。

user host=(runas) commands

user可以使用username、#uid、user_alias、%group、%#gid等；host可以使用ip、hostname、network等；command可以使用command name、directory

在配置文件中，指定用户别名User_Alias USERNAME = 1user，2user，...，其中定义的用户名必须为大写字母，可以把这个看作为定义的一个用户组。指定命令别名Cmnd_Alias COMMANDS = command1，command2，这可以看做命令的集合。Alias_Type有User_Alias、Host_Alias、Runas_Alias、Cmnd_Alias。

用户在使用sudo时，需要验证当前用户的密码，sudo有检票时间，检票时间的有效时长是5分钟，如果5分钟之内都没执行sudo，再次执行sudo需要输入用户密码。使用sudo -k清除检票记录的用户密码。sudo默认以root身份运行命令，也可以使用sudo -u user来指定以哪个用户运行命令。

对于一些没有root密码的管理员，可以使用sudo su -来切换到root用户。

对于sudo授权，如果要对用户授权关于密码的操作，那么要禁止用户修改管理员密码，定义一个Cmnd_alias=/usr/bin/passwd [a-z]*,!/usr/bin/passwd root

sudo的所有操作会记录在日志中。

## 文件共享服务

在linux中，有三种文件共享服务

- 工作在应用层的ftp服务
- 工作在内核的nfs：跨平台困难(windows)
- 跨平台文件协作服务samba：在linux实现CIFS(SMB)协议

 存储模型有三种：DAS、NAS、SAN

- DAS：直接附加存储，直接附加在主板上的存储
- NAS：网络附加存储，文件级别共享
- SAN：块级别共享

ftp(File Transfer Protocol)是应用层协议，CS架构，监听在tcp21端口，服务端监听在tcp21号端口监听命令连接。ftp需要传输两种数据：

- 命令连接：文件管理类命令，始终在线链接，
- 数据连接：数据传输，按需创建及关闭的连接。

ftp的数据传输格式支持文本格式传输和二进制传输。ftp的传输有主动连接和被动连接两种模式，主动连接由服务器创建连接，被动连接是由客户端创建连接。主动连接中客户端命令连接使用随机端口连接服务端21号端口，数据连接使用服务端tcp20号端口主动连接客户端50000+1号端口，如果端口占用，继续加1，实际上客户端会将自己已经打开的端口通知服务器。被动模式中，命令连接依然是由客户端发起，客户端使用随机端口连接服务端21号端口，数据连接也由客户端发起，客户端使用50000+1（或以此类推）向服务端随机端口连接，随机端口会在命令连接中告知客户端。

ftp的Server端有：wu-ftpd、proftpd、pureftp、vsftpd、ServU。

ftp的Client端有：ftp、lftp、wget、curl、filezilla、gftp(Linux GUI)、flashfxp、cuteftp

ftp和http协议相似，也有响应码

- 1XX：信息
- 2XX：成功类的状态码
- 3XX：提示需进一步提供补充类信息的状态码
- 4XX：客户端错误
- 5XX：服务端错误

ftp也有用户认证，ftp既支持系统用户认证也支持虚拟用户认证，虚拟用户仅用于访问特定服务的资源。ftp还支持匿名用户登录。即使使用了匿名或虚拟账户，最后还是要以一个系统用户运行程序。

系统中有两个应用框架，名称解析框架nsswitch(network service swithc)/etc/nsswitch.conf（相关模块/lib64/libnss* 和/usr/lib64/libnss*）和用户认证框架pam(pluggable authentication module)/etc/pam.conf和/etc/pam.d/(相关模块/lib64/security)。应用可以借助这两个框架加以相关配置文件进行解析和认证。

CentOS6中自带的是vsftpd，默认可能没有安装，默认vsftpd使用系统用户来进行认证。

日志滚动文件：/etc/logrotate.d/vsftpd
用户认证配置文件：/etc/pam.d/vsftpd

配置文件：/etc/vsftpd     主配置文件：/etc/vsftpd/vsftpd.conf

主程序：/usr/sbin/vsftpd

匿名用户(映射为ftp用户)共享资源位置：/var/ftp，ftp用户的家目录是/var/ftp

系统用户通过ftp访问的资源位置是用户自己的家目录，虚拟用户通过ftp访问资源的位置是给虚拟用户指定的映射成为系统用户的家目录

**匿名用户的配置**

anonymous_enable=YES允许匿名用户登录

anon_upload_enable=YES允许匿名用户上传文件，默认禁用，禁用功能将此行注释即可

anon_mkdir_write_enable=YES允许匿名用户创建目录，默认禁用

anon_other_write_enable=YES允许匿名用户的其他写权限，如删除等，默认禁用

**系统用户的配置**

local_enable=YES允许系统用户登录

write_enable=YES允许本地用户写权限

local_umask=022本地用户上传文件的默认权限644

chroot_local_user=YES锁定所有ftp本地用户于其家目录中

chroot_list_enable=YES锁定指定ftp本地用户于其家目录中，指定文件在chroot_list_file=/etc/vsftpd/chroot_list，在文件中的用户进行锁定

**日志**

xferlog_enable=YES是否启用日志

xferlog_file=/var/log/xferlog指定日志文件

xferlog_std_format=YES日志记录信息格式

**改变上传文件的属主**

chown_uploads=YES

chown_username=whoever

**用户登录控制**

pam_service_name=vsftpd指定pam用到的配置文件/etc/pam.d/vsftpd

userlist_enable=YES

userlist_deny=YES|NO      yes为白名单，no为黑名单

tcp_wrappers=YES

默认文件为/etc/vsftpd/user_list

**vsftpd连接限制**

max_clients最大并发连接数

max_per_ip每个ip可同时发起的并发请求数

**传输速率限制**

anon_max_rate匿名用户的最大传输速率， 单位是“字节/秒”

local_max_rate本地用户的最大传输速率

**虚拟用户**

所有的虚拟用户会被统一映射为一个指定的系统账户，访问的共享位置即为此系统账号的家目录。

各虚拟用户可被赋予不同的访问权限，通过匿名用户的权限控制参数进行指定：

虚拟用户账号的存储方式：

- 文本文件

  文本文件中，奇数行为用户名，偶数行为密码。

  文件需要被编码为 hash格式

- 关系型数据库的表中

  即时查询数据库来完成用户认证

  要使用mysql，pam要依赖于pam-mysql。