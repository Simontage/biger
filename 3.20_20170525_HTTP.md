# HTTP

计算机网络通信模型有OSI参考模型和当前正在使用TCP/IP模型

![](http://om8bgr2y6.bkt.clouddn.com/OSI_Vs_TCPIP_Model.png)



从linux的角度看计算机网络的通信模型，物理层是通过硬件实现的，数据链路层是通过相关硬件的驱动程序实现的，网络层和传输层在内核中实现，应用层在用户空间实现。

应用层的重点是不同的程序实现特有的一些功能，TCP/IP的下三层更通用，重点是数据的传送

物理层提供设备到设备的通信，网络层提供主机到主机的通信，传输层为进程提供端到端的通信服务，传输层使用端口来区分各个进程，传输层使用的协议常用的有两种，TCP和UDP

网络通信实际上也是两个进程之间的通信，套接字(Socket)是进程通信的一种方式，允许位于不同主机的不同进程进行通信，套接字是进程间数据流的端点，以IP协议为通信基础的套接字称为网络套接字，以本地文件系统通信的套接字称为Unix Socket。

套接字有三种类型，一种是以TCP为基础的SOCK_STREAM，一种是以UDP为基础的SOCK_DGRAM，还有一种直接以IP为基础的raw socket

IANA将0-1023的端口已经永久分配给固定的应用使用，叫做特权端口；1024-41951范围内的端口也是由IANA进行注册的端口，但要求不严格，可分配给开发者注册为某应用使用；41952之后的端口是客户端随机使用的端口，也叫做动态端口或私有端口，其范围由/proc/sys/ipv4/ip_local_port_range文件定义。

客户端和服务端组成一组套接字，服务端使用固定的端口监听，客户端使用随机端口。

Socket Domain根据所使用的地址不同，Socket分为AF_INET、AF_INET6、AF_UNIX。

- AF_INET
- AF_INET6
- AF_UNIX：同一主机上不同的进程通信时使用

每类套接字都至少提供了两种Socket数据传输机制：流和数据报。流可以可靠地传递并且是面向连接的，而且是无边界的；数据报是不可靠地传递，报文有边界、无连接。

与套接字相关的系统调用有

- socket()：创建套接字
- bind()：绑定套接字
- listen()：监听套接字
- accept()：接受请求
- connect()：请求连接建立
- write()：发送
- read()：接收

## HTTP协议

**超文本传输协议**(英文:**HyperText Transfer Protocol**，缩写：**HTTP**)是互联网上广泛使用的协议，提供了一种发布和接收HTML页面的方法。通过HTTP或HTTPS协议请求的资源由统一资源标识符(Uniform Resource Identifiers,URI)来标识。

C/S架构是一种网络架构，分为客户端和服务端，客户端和服务端要使用相同的协议才可以正常的通信，C/S架构最常见的就是在互联网所浏览的网页，使用的http协议，监听在tcp80端口，用来传输使用html标记的文件，http的客户端多数是浏览器（browser），服务端是http server。

**多用途互联网邮件扩展**（**MIME**，**Multipurpose Internet Mail Extensions**）的引入使html可以支持多媒体，服务端将非文本格式的数据编码为文本数据，客户端将文本数据还原为非文本格式的数据。

HTTP请求对象的内容叫做web资源(web resource)，静态文件是最基本的资源，如文本、音频、视频。web资源也有动态资源，如php、jsp。一个页面中展示的资源可能有多个；每个资源都需要单独请求。

资源(媒体)有类型，又称为MIME类型，有主类型和次类型major/minor，如text/html、text/plain、image/gif、video/mpeg。

每个资源的唯一标识符叫做URL，URL是统一资源定位符，是URI的子集，URI是统一资源标识符。URL用于描述某服务器特定资源的位置

URL(Uniform Resource Locator)，由三部分组成：URL方案scheme、服务器地址ip:port、资源路径。

URL一般格式：\<scheme>://\<user>:\<password>@\<host>:\<port>/\<path>;\<params=>?\<query=>#\<frag>

URL分为绝对URL和相对URL

**http协议的版本**

- HTTP/0.9：原型版本
- HTTP/1.0：第一个广泛使用的版本，支持MIME，有缓存缺陷，支持keep-alive
- HTTP/1.1：广泛使用的版本，更多的请求方法，更精细的缓存控制，支持持久连接
- HTTP/2.0：与2015年5月作为互联网标准正式发布

**一次完整的HTTP请求处理过程**

1、建立或处理连接：接收或拒绝请求

2、接收请求：接收来自于来自于网络请求报文中对某一资源的一次请求过程

3、处理请求：对请求报文进行解析，并获得请求的资源及请求方法等相关信息。请求报文的首部有请求方法、url、请求主机名称、Connection等

4、访问资源：获取请求报文中请求的资源。web服务器即存放了web资源的服务器，负责像请求者提供对方请求的静态资源或动态运行后生成的资源，这些资源放置于本地文件系统某路径下，此路径通常称为DocRoot

5、构建响应报文：

​	标记资源的MIME类型：显示分类、魔法分类、协商分类

​	web服务器构建的响应并非客户端请求的资源，而是向客户端提供资源的另外一个访问路径，这叫做URL重定向

6、发送响应报文

7、记录日志

**web服务端接收请求时的并发访问模型（web i/o）**

- 单进程IO结构：启动一个进程处理用户请求，而且一次只处理一个；多个请求被串行响应；
- 多进程IO结构：启动多个进程，每个进程响应一个请求
- 复用IO结构：一个进程响应多个请求
  - 多线程模型：一个进程生成多个线程，每个线程响应一个用户请求；对于Linux而言进程和线程响应量级相似
  - event-driven：事件驱动，一个进程直接响应N个请求
- 复用多线程IO结构：启动多个线程，每个线程响应多个请求

服务端资源映射方式

- Docroot
- 路径别名
- 虚拟主机Docroot映射
- 用户家目录docroot映射


**HTTP报文**

一次请求以及与其对应的响应被称为http的事务，http一种无状态（stateless）协议，一次http事务结束后，连接断开，服务器无法持续追踪客访问者来源，所以引入了cookie和session机制来追踪同一个用户

每请求一个资源都需要tcp三次握手，效率十分低下，使用并行请求或保持连接来提高效率。保持连接有两个条件触发断开保持连接，限制时间或请求资源数。

http方法：GET、put、head、post、delete

http请求：request请求报文

```
<method> <request-url> <version> #起始行（请求行）
<headers>

<entity-body>
```

http响应：response响应报文

```
<vsesion> <status> <reson-phrase> #起始行（响应行）
<headers>

<entity-body>
```

\<method>：请求方法，标明客户端希望服务器对资源执行的动作。常用的有GET、HEAD、POST

- GET：请求从服务器获取一个资源，安全方法
- HEAD：只从服务器获取文档的响应首部，不需要发送资源，安全方法
- POST：向服务器发送要处理的数据，支持html表单提交
- PUT：将请求的主体部分存储在服务器上
- DELETE：请求删除服务器上指定的文档
- TRACE：追踪请求到达服务器中间经过的代理服务器
- OPTIONS：请求服务器返回对指定资源支持使用的请求方法

\<request-url>：请求的资源，可以使相对路径，也可以是完整的URL

\<version>：协议版本，格式为HTTP/\<major>.\<minor>，如http/1.1

**\<headers>**：每个请求或响应报文可包含多个首部，每个首部都有首部名称，后面跟一个冒号，而后跟上一个可选空格，接着是一个值

- 通用首部：请求和相应都可以使用
  - Connection：定义C/S之间关于请求/响应的有关选项，如在http/1.0中，Connection：keep-alive
  - Via：显示了报文经过的中间节点
  - Cache-Control：缓存控制
  - Date：报文的创建时间
- 请求首部
  - Client-IP：客户端IP。下四层的信息由内核处理，IP被拆掉，实际上也有其他方法获取客户端IP
  - Host：请求的主机名和端口号。虚拟主机环境下用于标识不同的虚拟主机
  - Referer：指明了当前请求的资源是从何处来的，包含当前正在请求的资源的上一级资源。如防盗链，投放广告效果分析
  - User-Agent：用户代理，使用什么工具发出的请求
  - Accept：通知服务器自己可以接受的媒体类型，标明客户端更倾向于使用的方式
    - Accept：指明服务器能发送的媒体类型
    - Accept-Charset：支持使用的字符集
    - Accept-Encoding：支持使用的编码方式，如gzip
    - Accept-Language：支持使用的语言
  - 条件请求
    - Expect
    - If-Modified-Since：是否在指定的时间后修改过此资源
    - If-None-Match：本地缓存中存储的文档的ETag标签是否与服务器文档的Etag不匹配
  - 安全相关
    - Authorization：客户端提交给服务端的认证数据，如账号和密码
    - Cookie/Cookie2：客户端发送给服务端的身份标识
  - 代理请求首部
    - Proxy-Authorization：向代理服务器认证
- 响应首部
  - 信息性首部
    - Age：响应持续的时间
    - Server：向客户端标明服务器程序名称、版本
  - 协商首部：某资源有多种表示方法时使用
    - Accept-Ranges：对当前资源来讲，服务器能够接受的范围类型
    - Vary：首部列表，服务器会根据列表中的内容，挑选出适合的版本发送给客户端
  - 安全相关
    - Set-Cookie/Cookie2：在客户端第一次请求时，服务端发送的令牌
    - WWW-Authentication：质询，要求客户端提供账号和密码
- 实体首部：用于指定实体部分的属性
  - Location：资源的新位置
  - Allow：允许对此资源使用的请求方法
  - 内容首部
    - Content-Encoding
    - Content-Language
    - Content-Lentgth
    - Content-Location
    - Content-Type
  - 缓存首部
    - ETag：实体标签
    - Expires：过期期限
    - Last-Modified：上一次的修改时间
- 扩展首部：非标准 首部，可能由程序开发者创建的。

**\<status>**：状态码，三位数字，如200、404、502，标记请求处理过程中发生情况

- 1xx：100-101, 信息提示状态码
- 2xx：200-206, 成功状态码
  - **200**：成功，请求的所有数据通过响应报文的entity-body部分发送。简要描述为OK
- 3xx：300-305（？307）, 重定向状态码
  - **301**：请求URL指向的资源已被删除，在响应报文中通过首部location指明了资源现在所处的位置。简要描述为Move permanently
  - **302**：与301相似，在响应报文中通过location指明了资源现在所处的临时位置。简要描述为Found
  - **304**：客户端发出了条件式请求，但服务器上的资源未曾发生改变，则通过此状态码告知客户端。简要描述为Not Modified
- 4xx：400-415, 错误类信息，客户端错误
  - **401**：需要输入帐号和密码认证，方能访问资源。简要描述为unauthorized
  - **403**：请求被禁止。简要描述为Forbidden
  - **404**：服务器无法找到客户端请求的资源。简要描述为Not Found
  - 405：Method Not Allowed
- 5xx：500-505, 错误类信息，服务器端错误
  - **500**：服务器内部错误。简要描述为internal Server Error
  - **502**：代理服务器从后端服务器收到了一条伪响应。简要描述为Bad Gateway
  - 503：ServiceUnavailable

\<reson-phrase>：原因短语，解释状态码

\<entity-body>：主体部分

http协议分析可以使用tcpdump、tshark和wireshark等抓包分析工具

## httpd

常见的web服务器程序有httpd、nginx、Lighttpd，还有一些应用程序服务器（APP Server），可以返回动态内容，如ISS、tomcat、jboss、resin、webshpere、weblogic、oc4j。

美国的机构会定期统计各web服务程序在市场的占有率

httpd的版本主要有2.0、2.2、2.4，在CentOS 6默认提供的版本是2.2，CentOS 7默认提供的是2.4

**httpd的特性**

- 高度模块化：由core和各种modules组成

- **DSO**(Dynamic Shared Object)机制：支持模块的动态装卸载

- **MPM**(Multipath-Processing Modules)机制：多路处理模块 ，非一个模块，是一种机制

  - prefork模块：多进程模型，每个进程响应一个请求。

    主进程负责接收请求但不处理请求，一个主进程负责生成多个子进程以及回收子进程，每个子进程处理一个用户请求，即便没有用户请求，也会预先生成多个空闲进程，随时等待请求到达，并发请求最大不会超过1024个。

  - worker：多线程模型，每个线程相应一个请求。一个主进程生成多个线程，每个线程响应一个请求；

  - event：事件驱动模型，一个线程响应多个请求。一个主进程生成m个线程程，每个线程相应n个请求；

**httpd的功能特性**

- 支持虚拟主机virtual host
- CGI(Common Gateway Interface)通用网关接口
- 反向代理
- 支持负载均衡
- 支持路径别名alias
- 丰富的用户认证机制authentication
- 支持第三方模块。

## httpd 2.2

在centos6中，rpm包默认提供的是httpd2.2。

使用rpm安装httpd的主配置文件在/etc/httpd/conf/httpd.conf，补充配置文件在/etc/httpd/conf.d/目录中

/etc/httpd/目录是网站服务的根目录，也是httpd的程序目录

httpd的服务脚本在/etc/rc.d/init.d/httpd，服务脚本的配置文件在/etc/sysconfig/httpd

httpd的主程序文件有三个：/usr/sbin/httpd、/usr/sbin/httpd.event、/usr/sbin/httpd.worker

日志文件在/var/log/httpd目录中，日志文件有两个，一个是access_log访问日志，另外一个是error_log错误日志文件

站点文档目录在/var/www/html

httpd的模块文件目录在/usr/lib64/httpd/modules

httpd的主配置文件有三部分组成，分为了三个Section，第二段和第三段不要同时使用

Section 1：Global Environment

Section 2：‘Main’ server configuration

Section 3：Virtual Hosts

一般格式是 directive value，directive不区分大小写，value是文件路径时取决于文件系统。

常用配置：

1. 修改监听的ip和端口：Listen [IP:]PORT
    ip地址可以省略，表示监听所有ip地址
    Listen可以有多条

2. 持久连接Persistent Connection
    每个资源获取完后不会立即断开连接，而是继续等待其他资源请求
    对并发访问量较大的服务器，持久连接可能会使一些访问请求得不到响应
    一个折中的解决方案就是使用较短的持久连接时间，在2.4中可以支持毫秒级持久时间
    使用数量限制来断开持久连接：默认为100个
    使用时间限制来断开持久连接：可配置，单位是秒
    KeepAlive On| Off
    MaxKeepAliveRequests：
    KeepAliveTimeout：
    测试持久连接：
    telnet HOST PORT
    GET /URL HTTP/1.1
    HOST:HOSTNAME|IP

3. 多路处理模块MPM

   http2.2不支持同时编译多个模块，在编译时只能选择一个，rpm安装的包提供了三个二进制程序文件，分别实现了对不同mpm机制的支持。

   使用ps -aux | grep httpd，可以查看运行的httpd的类型，默认运行的是/usr/sbin/httpd，使用的是prefork

   使用ps命令查看的httpd类型加上-l 查看在核心中静态编译的模块

   使用httpd -M显示当前httpd加载的所有模块（静态编译+动态装载模块）

   更换使用的httpd程序：编辑脚本配置文件/etc/sysconfig/httpd中HTTPD=...

4. 主配置文件中模块的配置

   prefork的配置

   ```
   <IfModule prefork.c>
   StartServers       8
   MinSpareServers    5
   MaxSpareServers   20
   ServerLimit      256
   MaxClients       256
   MaxRequestsPerChild  4000
   </IfModule>		
   ```

   worker的配置

   ```
   <IfModule worker.c>
   StartServers         4 #服务启动时启动的进程数，但不包含主进程
   MaxClients         300 #最大并发请求数量
   MinSpareThreads     25 #最少空闲进程
   MaxSpareThreads     75 #最大空闲进程。这就是为什么使用ps一会是4个进程，一会是三个进程
   ThreadsPerChild     25 #每个进程启动的线程数
   MaxRequestsPerChild  0 #
   </IfModule>
   ```

5. DSO机制：配置指令实现模块加载

   LoadModule \<mod_name>  \<mod_path>

   模块路径可以使用相对路径，相对路径是相当于ServerRoot（/etc/httpd）指向的路径而言。

   /etc/httpd/modules是一个符号链接指向了模块的目录

   也可以在配置文件中修改

6. 定义'Main' server的文档页面路径：DocumentRoot

   DocumentRoot指向的路径为URL路径的起始位置

7. 站点访问控制：

   可基于两种类型的路径指明对哪些资源进行访问控制

   基于文件系统路径：

   \<Directory ""> \</Direcotry> 

   \<File ""> \</File>

   \<FileMatch ""> \</FileMatch>

   基于URL路径：\<Location ""> \</Location>

   访问控制的机制：

   基于来源地址

   基于帐号

8. 在Directory中“基于来源地址”实现访问控制

   （1）Options：定义用户对目录下资源的访问特性，value的值有Indexes（索引）、FollowSymLinks（允许跟踪符号链接文件）等

   （2）基于来源地址的访问控制机制

   ​	Order：检查次序。如Order allow，deny（默认都deny，只有前面allow的可以访问）或order deny，allow

   ​	Allow from

   ​	Deny from

   ​	来源地址可以是ip地址也可以是网络地址、FQDN。

   ​	网络地址的表示：

   ​	172.16

   ​	172.16.0.0

   ​	172.16.0.0/16

   ​	172.16.0.0/255.255.0.0

9. 定义默认主页面：可以有多个默认界面

   DirecotryIndex index.html index.html.var

10. 日志设定

 错误日志的设置使用ErrorLog logs/error_log

 设定写入日志级别LogLevel warn

 日志级别由低到高：debug, info, notice, warn, error, crit, alert, emerg

 访问日志也需要两个字段定义

 CustomLog logs/access_log combined（此字段是日志格式）

 LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined

 ```
 %h：Remote Host客户端IP地址
 %l: Remote logname (from identd, if supplied)。-表示为空
 %u: Remote user,  (from auth; may be bogus if return status (%s) is 401)。-表示为空
 %t：Time the request was received (standard english format)，服务器收到请求的时间
 %r：First line of request，请求报文的首行信息(method url version)
 %>s: 响应状态码
 %b: 响应报文的大小，单位是字节，不包括响应报文首部
 %{Referer}i：请求报文当中"referer"首部的值；当前资源的访问入口，即从哪个页面中的超链接跳转而来的
 %{User-Agent}i：请求报文当中"User-Agent"首部的值；即发出请求用到的应用程序，通常是浏览器，也可是压力测试工具，或是爬虫工具
 官方文档：http://httpd.apache.org/docs/2.2/mod/mod_log_config.html#formats
 ```

11. 路径别名

    Alias /URL/ "/path/to/somewhere"

    如：Alias /bbs/ "/forum/htdocs"

    ​       http://www.jsp.com/bbs/index.html 使用别名后，文件在/forum/htdocs

12. 设定默认字符集

    AddDefaultCharset UTF-8

13. 基于用户的访问控制

    认证质询：WWW-Authenticate，响应码为401，拒绝客户端请求，并说明要求客户端提供帐号和密码

    认证：Authorization，客户端用户填入账号和密码后再次发送请求报文。认证通过服务端发送响应资源

    认证类型：basic明文和digest消息摘要

    安全域：需要用户认证后方能访问的路径。每个安全域应该通过名称对其进行标识，并用于告知用户认证的原因

    用户的帐号和密码使用的虚拟账号，仅用于访问某服务时用到的认证标识。

    basic认证：

    （1）定义安全域

    ```
    <Directory "/somedir">
    	Options None
    	AllowOverride None
    	AuthType Basic
    	AuthName "STRING"
    	AuthUserFile "/PATH/TO/HTTPD_USER_PASSWD_FILE"
    	Require user username1 username2 ...
    </Directory>
    允许账号文件中的所有用户登录访问：Require valid-user
    ```

    （2）提供帐号和密码存储文件（演示使用文本文件）

    ```
    使用htpasswd命令进行管理
    htpasswd [options] passwordfile username。
    -c: 自动创建passwordfile，因此，仅应该在添加第一个用户时使用；
    -m: md5加密用户密码；
    -s: sha1加密用户密码；
    -D: 删除指定用户
    ```

    （3）实现基于组进行认证

    ```
    <Directory "">					
    	Options None
    	AllowOverride None
    	AuthType Basic
    	AuthName "STRING"
    	AuthUserFile "/PATH/TO/HTTPD_USER_PASSWD_FILE"
    	AuthGroupFile "/PATH/TO/HTTPD_GROUP_FILE"
    	Require group GROUP1 GROUP2 ...
    </Directory>	
    要提供用户帐号文件和组文件
    组文件手动创建，每一行定义一个组，GRP_NAME：user1 user2 user3 ...
    示例：
    <Directory "/www/htdocs/admin">
        Options None
        AllowOverride None
        AuthType Basic
        AuthName "Administator private"
        AuthUserFile "/etc/httpd/conf.d/.htpasswd"
        AuthGroupFile "/etc/httpd/conf.d/.htgroup"
        Require group webadmin
    </Directory>
    ```

14. 虚拟主机

    虚拟主机有三种实现方案

    基于ip：为每个虚拟机准备至少一个ip地址。

    基于port：为每个虚拟主机准备至少一个专用port，实践中很少使用

    基于hostname：为每个虚拟主机准备至少一个专用hostname。比较实用

    可混合使用上述三种方式中的任意方式

    一般虚拟主机不要和中心主机混用，所以，要使用虚拟主机，先禁用中心主机：注释DocumentRoot

    每个虚拟主机都有专用配置

    ```
    <VirtualHost "IP:PORT">
    	SeverName
    	DocumentRoot ""
    </VirtualHost>
    大部分用在中心主机的配置都可以在虚拟主机中使用，如：
    ServerAlias: 虚拟主机的别名；
    ErrorLog
    CustomLog
    <Directory "">
    </Directory>
    使用http -t或者service httpd configtest来对httpd的配置文件进行测试
    ```

    基于ip

    ```
    <VirtualHost 172.16.100.6:80>
        ServerName web1.jsp.com
        DocumentRoot "/vhosts/web1/htdocs"
        CustomLog ...... combined
    </VirtualHost>

    <VirtualHost 172.16.100.7:80>
        ServerName web2.jsp.com
        DocumentRoot "/vhosts/web2/htdocs"
        CustomLog ...... combined
    </VirtualHost>
    ```

    基于port

    ```
    <VirtualHost 172.16.100.7:80>
        ServerName web2.jsp.com
        DocumentRoot "/vhosts/web2/htdocs"
        CustomLog ...... combined
    </VirtualHost>

    <VirtualHost 172.16.100.7:8080>
        ServerName web3.jsp.com
        DocumentRoot "/vhosts/web3/htdocs"
        CustomLog ...... combined
    </VirtualHost>
    ```

    基于hostname

    ```
    NamevirtualHost 172.16.100.6：80
    <VirtualHost 172.16.100.6:80>
        ServerName web1.jsp.com
        DocumentRoot "/vhosts/web1/htdocs"
        CustomLog ...... combined
    </VirtualHost>

    <VirtualHost 172.16.100.6:80>
        ServerName web2.jsp.com
        DocumentRoot "/vhosts/web2/htdocs"
        CustomLog ...... combined
    </VirtualHost>

    <VirtualHost 172.16.100.6:80>
        ServerName web3.jsp.com
        DocumentRoot "/vhosts/web3/htdocs"
        CustomLog ...... combined
    </VirtualHost>
    ```

15. 内置的status页面

    ```
    <Location /server-status>
        SetHandler server-status
        Order deny,allow
        Deny from all
        Allow from 172.16
    </Location>	
    ```


**httpd自带的工具程序**

htpasswd: basic认证基于文件实现时，用到的账号密码文件生成工具；
apachectl：httpd自带的服务控制脚本，支持start, stop；
apxs：由httpd-devel包提供的，扩展httpd使用第三方模块的工具；
rotatelogs：日志滚动工具；
​	access.log -->
​	access.log, access.1.log
​	access.log, access.1.log, access.2.log
suexec：访问某些有特殊权限配置的资源时，临时切换至指定用户运行；

ab: apache benchmark

**http压力测试工具**

ab
webbench
http_load

jmeter
loadrunner

tcpcopy

ab [OPTIONS] URL
​	-n: 总的请求数
​	-c：模拟的并发数
​	-k: 以持久连接模式测试

ulimit -n #: 调整当前用户所同时打开的文件数；

充分理解并解释压力测试结果

## CLI下的http client

curl是基于URL语法在命令行方式下工作的文件传输工具，它支持FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE及LDAP等协议。curl支持HTTPS认证，并且支持HTTP的POST、PUT等方法， FTP上传， kerberos认证，HTTP上传，代理服务器， cookies， 用户名/密码认证， 下载文件断点续传，上载文件断点续传, http代理服务器管道（ proxy tunneling）， 甚至它还支持IPv6， socks5代理服务器,，通过http代理服务器上传文件到FTP服务器等等，功能十分强大。

一般使用格式：curl \[options][URL...]

```
-A/--user-agent <string> 设置用户代理发送给服务器
-basic 使用HTTP基本认证
--tcp-nodelay 使用TCP_NODELAY选项
-e/--referer <URL> 来源网址
--cacert <file> CA证书 (SSL)
--compressed 要求返回是压缩的格式
-H/--header <line>自定义首部信息传递给服务器
-I/--head 只显示响应报文首部信息
--limit-rate <rate> 设置传输速度
-u/--user <user[:password]>设置服务器的用户和密码
-0/--http1.0 使用HTTP 1.0
```

另外一个工具叫elinks，一般使用格式：elinks [OPTION]... [URL]...

```
-dump：不进入交互模式，而直接将url的内容输出至标准输出
```

使用mod_deflate模块压缩页面优化传输速度，默认不启用

适用场景：

(1) 节约带宽，额外消耗CPU；同时，可能有些较老浏览器不支持；

(2) 压缩适于压缩的资源，例如文件文件；

```
SetOutputFilter DEFLATE

# mod_deflate configuration


# Restrict compression to these MIME types
AddOutputFilterByType DEFLATE text/plain 
AddOutputFilterByType DEFLATE text/html
AddOutputFilterByType DEFLATE application/xhtml+xml
AddOutputFilterByType DEFLATE text/xml
AddOutputFilterByType DEFLATE application/xml
AddOutputFilterByType DEFLATE application/x-javascript
AddOutputFilterByType DEFLATE text/javascript
AddOutputFilterByType DEFLATE text/css

# Level of compression (Highest 9 - Lowest 1)
DeflateCompressionLevel 9
 
# Netscape 4.x has some problems.
BrowserMatch ^Mozilla/4 gzip-only-text/html
 
# Netscape 4.06-4.08 have some more problems
BrowserMatch ^Mozilla/4\.0[678] no-gzip
 
# MSIE masquerades as Netscape, but it is fine
BrowserMatch \bMSI[E] !no-gzip !gzip-only-text/html
```

## HTTPS

http over ssl = https 443/tcp

ssl: v3

tls: v1

https://

SSL会话的简化过程

(1) 客户端发送可供选择的加密方式，并向服务器请求证书；

(2) 服务器端发送证书以及选定的加密方式给客户端；

(3) 客户端取得证书并进行证书验正：

​	如果信任给其发证书的CA：

​		(a) 验正证书来源的合法性；用CA的公钥解密证书上数字签名；
​		(b) 验正证书的内容的合法性：完整性验正
​		(c) 检查证书的有效期限；
​		(d) 检查证书是否被吊销；
​		(e) 证书中拥有者的名字，与访问的目标主机要一致；

(4) 客户端生成临时会话密钥（对称密钥），并使用服务器端的公钥加密此数据发送给服务器，完成密钥交换；
(5) 服务用此密钥加密用户请求的资源，响应给客户端；		

SSL会话是基于IP地址创建；所以单IP的主机上，仅可以使用一个https虚拟主机；	

**配置httpd支持https**

(1) 为服务器申请数字证书

测试：通过私建CA发证书

 (a) 创建私有CA

(b) 在服务器创建证书签署请求

(c) CA签证

(2) 配置httpd支持使用ssl，及使用的证书

yum -y install mod_ssl

配置文件：/etc/httpd/conf.d/ssl.conf

```
DocumentRoot
ServerName
SSLCertificateFile
SSLCertificateKeyFile
```

(3) 测试基于https访问相应的主机

openssl s_client \[-connect host:port]\[-cert filename]\[-CApath directory][-CAfile filename]

## CentOS 7的httpd服务

在CentOS 7中，默认提供httpd的版本是2.4，使用RPM包安装httpd的默认路径是/etc/httpd，如果测试页不能正常打开，可以使用iptables或firewall-cmd来允许指定tcp端口或者允许指定的服务。

```
iptables -I input -p tcp -dport 80 -j ACCEPT
```

```
firewall-cmd --permanent --add-service http
```



httpd2.4的新特性

(1) MPM支持运行DSO机制；以模块形式按需加载；
(2) 支持event MPM；
(3) 支持异步读写；
(4) 支持每模块及每个目录分别使用各自的日志级别；
(5) 每请求配置；\<If>
(6) 增强版的表达式分析器；
(7) 支持毫秒级的keepalive timeout；
(8) 基于FQDN的虚拟主机不再需要NameVirtualHost指令；
(9) 支持用户自定义变量；

新模块

(1) mod_proxy_fcgi

(2) mod_ratelimit

(3) mod_remoteip

修改了一些配置机制：

不再支持使用Order, Deny, Allow来做基于IP的访问控制；

**安装httpd-2.4**

httpd依赖于apr-1.4+, apr-util-1.4+, [apr-icon]

apr: apache portable runtime

CentOS 6:默认：apr-1.3.9, apr-util-1.3.9 

编译安装步骤：

1.4+版的apr和apr-util

前提：

安装开发环境，安装pcre-devel

(1) apr

```
# ./configure --prefix=/usr/local/apr
# make && make install
```

(2) apr-util

```
# ./configure --prefix=/usr/local/apr-util --with=/usr/local/apr
# make && make install
```

(3)编译安装httpd2.4

```
# groupadd -r apache
# useradd -r -g apache apahce
# ./configure --prefix=/usr/local/apache --sysconf=/etc/httpd24 --enable-so --enable-ssl --enable-cgi --enable-rewrite --with-zlib --with-pcre --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util/ --enable-modules=most --enable-mpms-shared=all --with-mpm=prefork
# make && make install
```

启动服务：apachectl 

**CentOS7中的httpd2.4**

主配置文件：/etc/httpd/conf/httpd.conf

模块配置文件：/etc/httpd/conf.modules.d/*.conf

辅助配置文件：/etc/httpd/conf.d/*.conf

mpm：以DSO机制提供，配置文件00-mpm.conf

服务控制：systemctl {start|stop|restart|status|reload} httpd.service



