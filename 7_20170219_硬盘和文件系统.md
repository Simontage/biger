# 硬盘和文件系统基础

## 机械式硬盘

一块硬盘由一个马达带动的同轴多盘片结构，盘片双面可读写，为了能够实现读写，每一个面都被划分成了磁道（track），由厂商完成，磁道再一次划分为扇区，一般扇区大小为512字节

磁盘的角速度是固定不变的，每一个盘面上都有一个磁头，所有的磁头都由机械臂连接到一起，所有的磁头都会同步移动，读取文件的一般过程是移动磁头，等待存储数据的扇区转到磁头位置

在一块硬盘的不同盘面的相同磁道都划分成同一个分区，这些位于不同盘面上的相同编号的磁道，叫做柱面

硬盘在/dev/中

### 硬盘接口

- IDE(ATA)：并口，每个控制器可接两个硬盘分为master/slave，理论速率为133MB/s

  ​                   Linux表现为/dev/hd[a-z],分区的设备访问入口/dev/hda[1-4],逻辑分区从5开始

- SCSI：并口设备，小型计算机接口，与IDE同时期，理论速率320MB/s，  硬盘寿命更长

  ​           直接接管硬盘和内存之间的的IO，让cpu可以不用做低效的等待

- SATA：串口，SATA3理论速率为6Gbps

- SAS：串口，一个接口接一块硬盘，理论速率6Gbps

- USB

在centos6中都统一识别为/dev/sd[a-z]


## 文件系统

按名称存取是文件系统的主要目的，文件系统是一个软件，对磁盘上存在的二进制数据进行层次化管理

早期为了能够在一块硬盘上安装多个系统，把磁盘分成了多个分区，每一个分区当做独立的设备使用

划分分区是根据柱面进行的，外侧的磁道在相同时间内比内侧磁道划过的数据多，性能也就更好

### MBR

分区信息存储在硬盘的第0个扇区，第0个扇区不能用来划分区，这个扇区被称为MBR（master boot record）主引导记录

主引导记录里面存储着分区信息和BootLoader还有5A

为了引导不同的操作系统，系统就要知道去哪个分区找相应的操作系统，所以有一段程序在加电后执行，来选定要启动的操作系统，这一段程序叫做BootLoader，占用446字节

剩下的64个字节，用于存储分区信息，16个字节引导一个分区

剩下的2字节用于填充两个16进制的数据5A，是MBA有效性标记

一个硬盘只能有4个主分区，但从4个分区中拿出一个，存放其他的分区信息，这个分区是扩展分区，扩展分区是引用额外的分区表，不是一个真正的分区，扩展分区继续划分分区才能使用，划分的分区叫做逻辑分区

### 根的位置

系统的根在内核中，内核在磁盘只中

当系统加电，首先运行BootLoader，BootLoader识别各分区，然后访问分区的元数据区，识别文件，装载分区中的内核，内核启动后，内核将内存中的根所关联的分区作为文件访问入口将根分区的文件载入内存

只有系统所必须的所有功能都加载完毕，才可访问其他分区，所以/bin、/sbin等这些系统必须的文件必须放在根分区，否则系统无法启动

### 设备分区管理

**创建调整删除分区**

fdisk是常见的磁盘分区管理工具，可以查看磁盘分区情况和磁盘分区管理

使用fdisk /dev/sda会进入交互式命令行界面

```
d：删除分区
n：新建分区
p：列出现有分区
t：调整分区ID
l：列出内核支持的分区ID
w：保存退出
q：不保存退出
m：帮助
```

通知内核重新识别设备并创建设备文件，在centos5中执行partprobe；在centos6中执行partx -l或kpartx -af /dev/sda

一般来说，先使用kpartx -l /dev/sda，然后使用kpartx -af /dev/sda，再使用partx -a /dev/sda

### 文件系统分类

不同的文件系统内部文件组织和存放的方式不同，所以为了能够在不同的文件系统都能正确的读取写入文件，Linux内核中有一个翻译官叫做vfs虚拟文件系统，这样上层的应用程序就无需考虑文件系统是什么，由vfs进行转换。

内核为了识别不同的文件系统，给不同文件系统大类分配了ID号

Linux基于vfs可以识别的文件系统：

基本文件系统：Ext2、Ext3、Ext4、Reiserfs（海量小文件）、xfs（支持单个巨大文件）、Jfs、vflat、NTFS

交换分区：swap

集群文件系统：GFS2、OCFS2

网络文件系统：NFS、smbfs（CIFS）

分布式文件系统：通常需要第三方应用程序支持，内核无法识别

光盘：ISO9660